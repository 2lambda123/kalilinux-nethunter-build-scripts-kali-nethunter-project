#!/sbin/sh
# NetHunter kernel installer backend

## start build generated variables
generic="arm64"
## end build generated variables

if [ "$3" ]; then
	ZIPFILE=$3
	console=/proc/$$/fd/$2
	# write the location of the console buffer to /tmp/console for other scripts to use
	echo "$console" > /tmp/console
else
	console=$(cat /tmp/console)
	[ "$console" ] || console=/proc/$$/fd/1
fi

test "$ANDROID_ROOT" || ANDROID_ROOT=/system
SYSTEM="/system"

tmp=/tmp/nethunter/boot-patcher
print() {
	echo "ui_print ${1:- }" > "$console"
	echo
}

abort() {
	[ "$1" ] && {
		print "Error: $1"
		print "Aborting..."
	}
	restore_env
	print "Failed to patch boot image!"
	exit 1
}

#reference: https://github.com/osm0sis/AnyKernel3/blob/master/META-INF/com/google/android/update-binary#L33+L40
setup_mountpoint() {
  test -L $1 && $BB mv -f $1 ${1}_link;
  if [ ! -d $1 ]; then
    rm -f $1;
    mkdir -p $1;
  fi;
}
is_mounted() { $BB mount | $BB grep -q " $1 "; }

#for reference: https://github.com/osm0sis/AnyKernel3/blob/master/META-INF/com/google/android/update-binary#L91+L127
mount_all() {
  if ! is_mounted /data; then
    $BB mount /data;
  fi;
  setup_mountpoint $ANDROID_ROOT;
  if ! is_mounted $ANDROID_ROOT; then
    $BB mount -o rw -t auto $ANDROID_ROOT 2>/dev/null;
  fi;
  case $ANDROID_ROOT in
    /system_root) setup_mountpoint /system;;
    /system)
      if ! is_mounted /system && ! is_mounted /system_root; then
        setup_mountpoint /system_root;
        $BB mount -o rw -t auto /system_root;
      elif [ -f /system/system/build.prop ]; then
        setup_mountpoint /system_root;
        $BB mount --move /system /system_root;
      fi;
      if [ $? != 0 ]; then
        $BB umount /system;
        $BB umount -l /system 2>/dev/null;
        test -e /dev/block/bootdevice/by-name/system || local slot=$(getprop ro.boot.slot_suffix 2>/dev/null);
        $BB mount -o rw -t auto /dev/block/bootdevice/by-name/system$slot /system_root;
      fi;
    ;;
  esac;
  if is_mounted /system_root; then
    if [ -f /system_root/build.prop ]; then
      $BB mount -o bind /system_root /system;
    else
      $BB mount -o bind /system_root/system /system;
    fi;
  fi;
}

cleanup() {
       if [ "$ZIPFILE" ]; then
       print "Cleaning up..."
       rm /tmp/console
       cd $(dirname $tmp)
       rm -rf $tmp
       fi
}

install() {
	setperm "$2" "$3" "$tmp$1"
	if [ "$4" ]; then
		cp -r "$tmp$1" "$(dirname "$4")/"
		return
	fi
	cp -r "$tmp$1" "$(dirname "$1")/"
}

extract() {
	rm -rf "$2"
	mkdir -p "$2"
	unzip -o "$1" -d "$2" ||
		abort "Unable to extract! The zip may be corrupt or your device may not have enough RAM to proceed. Consider using a smaller installer if it is available."
}

setperm() {
	find "$3" -type d -exec chmod "$1" {} \;
	find "$3" -type f -exec chmod "$2" {} \;
}

restore_env() { 
   if [ ! -d /tmp/nethunter/boot-patcher ]; then
    $BB umount /system
    $BB umount -l /system
   if [ -e /system_root ]; then
      $BB umount /system_root
      $BB umount -l /system_root
    fi
  fi
  
  (for dir in /system /system_root; do
  if [ -L "${dir}_link" ]; then
  rmdir $dir
  $BB mv -f ${dir}_link $dir
  fi
  done) 2>/dev/null
  cleanup
}


if [ "$ZIPFILE" ]; then
print "##################################################"
print "##                                              ##"
print "##  88      a8P         db        88        88  ##"
print "##  88    .88'         d88b       88        88  ##"
print "##  88   88'          d8''8b      88        88  ##"
print "##  88 d88           d8'  '8b     88        88  ##"
print "##  8888'88.        d8YaaaaY8b    88        88  ##"
print "##  88P   Y8b      d8''''''''8b   88        88  ##"
print "##  88     '88.   d8'        '8b  88        88  ##"
print "##  88       Y8b d8'          '8b 888888888 88  ##"
print "##                                              ##"
print "########### NetHunter Kernel Installer ###########"

else 

print "##################################################"
print "          A/B and A Devices Boot-patcher"
if [ "$generic" ]; then
	print "  for $generic devices - ramdisk modifications only"
fi
print "##################################################"
fi

# Unpack the installer
[ "$ZIPFILE" ] && {
	print "Unpacking the installer, this may take a while..."
	extract "$ZIPFILE" "$tmp"
}
cd "$tmp"

BB=$tmp/tools/busybox
chmod 755 $BB

chmod +x env
. ./env.sh

print "Mounting partitions..."
mount_all
if [ $? != 0 ]; then
     abort "Cannot mount system partition read/write. Please mount '/system' manually and try again"
else 
     print "partitions mounted."
fi

setperm 0755 0755 tools

# Install additional busybox applets to /sbin in case something is missing during installation
print "Installing busybox applets to /sbin"
cp tools/busybox /sbin/busybox_nh
/sbin/busybox_nh --install /sbin

[ -f tools/freespace.sh ] && {
	# This actually runs twice when part of the NetHunter updater zip
	sh tools/freespace.sh ||
		abort "Not enough free space on /system to continue!"
}

[ -d system/etc/firmware ] && {
	print "Copying firmware to $SYSTEM/etc/firmware"
	install "/system/etc/firmware" 0755 0644 "$SYSTEM/etc/firmware"
}

[ -d system/etc/init.d ] && {
	print "Copying init.d scripts to $SYSTEM/etc/init.d"
	install "/system/etc/init.d" 0755 0755 "$SYSTEM/etc/init.d"
}

[ -d system/lib ] && {
	print "Copying 32-bit shared libraries to $SYSTEM/lib"
	install "/system/lib" 0755 0644 "$SYSTEM/lib"
}

[ -d system/lib64 ] && {
	print "Copying 64-bit shared libraries to $SYSTEM/lib64"
	install "/system/lib64" 0755 0644 "$SYSTEM/lib64"
}

[ -d system/bin ] && {
	print "Installing $SYSTEM/bin binaries"
	install "/system/bin" 0755 0755 "$SYSTEM/bin"
}

[ -d system/xbin ] && {
	print "Installing $SYSTEM/xbin binaries"
	install "/system/xbin" 0755 0755 "$SYSTEM/xbin"
}

[ -d data/local ] && {
	print "Copying additional files to /data/local"
	install "/data/local" 0755 0644
}

if [ "$ZIPFILE" ]; then
print "Running busybox installer..."
sh tools/installbusybox.sh #run only once
fi

if ["$ZIPFILE" ]; then
print "Running kernel installer..."
else
print "Running boot image patcher..."
fi
sh "META-INF/com/google/android/update-binary-anykernel" || abort

if [ "$ZIPFILE" ]; then
print "Kernel Installed Successfully"
else
print "Boot image patching completed";
fi

restore_env
